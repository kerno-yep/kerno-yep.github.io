---
layout: post
title: linux入侵排查
date: 2022-9-14
categories: blog
tags: [笔记]
description: linux应急

---

### Linux入侵简单排查  

***

#### 账号安全排查

- /etc/passwd
- /etc/shadow  
- awk -F: '$3==0 {print $1}' /etc/passwd    //排查超级用户
- last  //查看最近用户登录，注销信息
- lastlog -u USER   //查看指定用户登录信息

```shell
#排查处理
userdel -r user  #删除user用户,且删除/home目录下的账户目录
```

#### 进程排查

- ps aux  //进程相关信息
- ls -l /proc/PID/file   //查看pid所对应的进程文件路径
- lsof -c [进程]  //某个进程所打开相关文件信息

```shell
#排查处理
kill -9 [进程号]
rm -rf [文件]
```

#### 端口排查

- netstat -antlp | more

```shell
#排查处理
netstat -anp | grep PORT
kill -9 [进程号]
```

#### 计划任务排查

- crontab -l 
- /var/spool/cron/*

在排查以上内容完成处理后，仍有恶意计划任务启动，排查以下文件

- /etc/crontab  
- /etc/anacrontab  
- var/spool/anacron  
- /etc/cron.d/*
- /etc/cron.daily/*
- /etc/cron.hourly/*
- /etc/cron.monthly/*
- /etc/cron.weekly/*

```shell
#排查处理
当只需要删除某一条计划任务时，可以通过“crontab -e”命令进行编辑
而若要清空某个用户的所有计划任务，可以执行“crontab -r”命令
```

#### 历史命令排查

- history  //root历史命令
- /home/{user}/.bash_history  //普通用户账号历史命令

```shell
#排查处理
cat .bash_history >> 1.txt #留存分析
```

#### 日志排查

```shell
#查看 Linux ssh 登陆审计日志
/var/log/secure #Centos 与 RedHat 日志路径
/var/log/auth.log #Ubuntu 与 Debian 日志路径
```

#### 附件

```html
https://git.io/linux    <!--linux命令查询-->
https://github.com/grayddq/GScan/releases  <!--快速安全检查脚本-->
```

 [LinuxChk.sh](应急工具集\应急工具集\安全扫描\LinuxChk.sh) 

***

### 挖矿木马

挖矿病毒一般通过敏感端口，3306，22，23等或利用一些简单漏洞如weblogic，jboss反序列化等（因为挖矿团伙一般追求数量和速度，所以一般不会通过一些复杂的漏洞入侵）

职业化的挖矿一般会通过伪装进程，加壳，代码混淆，私搭矿池或代理的手段来规避安全分析与溯源。挖矿病毒往往会通过crontab设置周期性被执行的指令来保证能够在受害主机上持久化驻留。

***

#### 挖矿排查

挖矿处置思路：隔离主机 ->阻断异常通信->清除计划任务->清除启动项->排查文件->清理木马->分析溯源处理

快速响应思路：查进程->找挖矿文件路径->删进程，删文件->溯源排查

#### 进程排查

```shell
top -c #查看cpu占比最高的进程pid
ps aux | less
systemctl status $PID #排查有无守护进程
```

#### 异常连接排查

```shell
iptables -L -n
netstat -natp | grep $PID

```

#### 计划任务排查 

```shell
crontab -l 


#centos7有记录 crontab 日志
cd /var/log
cat cron* | grep RELOAD
```

#### 启动项排查

- /usr/lib/systemd/system
- /usr/lib/systemd/system/multi-user.target.wants
- /etc/rc.local
- /etc/inittab
- /etc/rc0.d/
- /etc/rc1.d/
- /etc/rc2.d/
- /etc/rc3.d/
- /etc/rc4.d/
- /etc/rc5.d/
- /etc/rc6.d/
- /etc/rc.d/

#### 获取挖矿文件路径

```shell
ls -l /proc/$PID/exe
```

#### 进程处置

```shell
kill -9 $PID #删除挖矿进程
ps -ef | grep "$关键字" |awk "{pint $2}" | xargs pkill #删除挖矿家族所有进程及守护进程
```

#### 文件处置

```shell
rm -rf $FILE #删除挖矿文件
find / -name "$FILE*" | xargs rm -rf
#当文件被赋予a i 属性无法rm时
chattr -a -i $FILE
rm -rf $FILE 2>/dev/null
```

#### 计划任务清理

```shell
vi /etc/crontab
crontab -e #root权限执行
```

#### 清理启动项

```shell
system disable 服务名（centOS7以上）
chkconfig 服务名 off（centOS7以下）
```

#### 挖矿处理tips

1. 定时任务有时手动删了还是没用，说明其有守护进程去监控定时任务的状态
   可以用top监控内存，一删掉定时任务 crontab -r(删除所有定时任务)，top 里就发现有进程的cpu在跳动，重点排查这个进程
2. 挖矿团伙使用的恶意脚本往往经过各种混淆,在清理时可以保留样本以供分析

#### 挖矿木马家族

##### SMBGhost挖矿

###### 入侵手段

入侵系统  |  windows  |  linux 
:--------:|:-------:|:--------:
入侵方式 | Lnk漏洞cve-2017-8464(移动设备) | ssh爆破 
  |Hadoop Yarn未授权访问|RDP爆破
  |永恒之蓝ms17-010|$IPC爆破
|SMB爆破|redis未授权访问
|mssql爆破|
|office漏洞cve-2017-8570(钓鱼邮件)|
|SMBGhost漏洞cve-2020-0796|
###### 受感染文件

/etc/crontab   
/var/spool/cron/'whoami'

##### kdevtmpfsi挖矿

###### 入侵手段

| 入侵系统 | windows |             linux              |
| :------: | :-----: | :----------------------------: |
| 入侵方式 |         |         Hadoop密码爆破         |
|          |         |      Solr dataimport RCE       |
|          |         | Hadoop Yarn REST API 未授权RCE |
|          |         |   Docker Remote API未授权RCE   |
|          |         |   ThinkPHP5 全局变量覆盖RCE    |
|          |         |      Confluence 未授权RCE      |

###### 受感染文件

/var/tmp/kinsing  
/tmp/kdevtmpfsi  
/var/spool/cron/'whoami'  
/tmp/dark.x86  
/tmp/dark.x86.1

##### DDG 挖矿

###### 入侵手段

|       入侵方式        |
| :-------------------: |
| Orientdb 漏洞（早期） |
| Redis 未授权访问漏洞  |
|      SSH 弱密码       |

###### 受感染文件

imWBR1(挖矿程序)  
wnTKYg  
2t3ik  
qW3xT  

##### 8220 挖矿

###### 入侵手段

|             入侵方式             |
| :------------------------------: |
| WebLogic XMLDecoder 反序列化漏洞 |
|     Drupal 远程代码执行漏洞      |
|    JBoss 反序列化命令执行漏洞    |
|        Couchdb 的组合漏洞        |
|         Redis 未授权访问         |
|    Hadoop Yarn 未授权访问漏洞    |

###### 受感染文件

wc.conf(配置文件)  
sutse（挖矿程序）

##### Mykings(theHidden)挖矿

###### 入侵手段

|  入侵方式  |
| :--------: |
| 3306 MySQL |
|  135 WMI   |
|   22 SSH   |
|  445 IPC   |
| 23 Telnet  |
|   80 Web   |
|  3389 RDP  |

###### 受感染文件

msinfo.exe  
ups.rar(持久化文件)  
lsmose.exe(挖矿程序)  

***

### Web日志分析

#### Apache日志

apache日志分为access_log和error_log  
access_log记录对apache服务器的`请求访问`  
error_log记录`错误请求`  
默认位置： `/var/log/apache2`  

#### Ngnix日志

ngnix日志分为access.log和error.log  
access.log记录`访问日志`  
error.log记录`错误信息`  
默认位置：`/var/log/ngnix` 

#### iis日志

默认位置：`C:\WINDOWS\system32\LogFiles`

#### Tomcat日志

tomcat日志分为catalina.out,localhost,manager,local_access_log  
catalina.out记录`运行中异常错误等`  
localhost.Y-M-D.log记录`内部代码异常日志`  
manager.Y-M-D.log记录`管理日志`  
localhost_access_log记录`访问日志`  
默认位置：`/tomcat/log`

#### weblogic日志

weblogic日志分为access.log，Server.log，domain.log  
access.log记录`http请求`  
sever.log记录`启动，关闭，部署信息`  
domain.log记录`doain的运行情况`

#### 分析技巧

```shell
find / -name "*.log"|xargs grep "webshell" #查询websell何时被上传的进行进一步溯源
```



***

### 勒索溯源

#### 确认勒索病毒种类

```html
<样本搜索确认>
https://lesuobingdu.360.cn/ <360勒索病毒搜索引擎>
https://guanjia.qq.com/pr/ls/ <腾讯勒索病毒搜索引擎>
https://lesuo.venuseye.com.cn/ <VenusEye勒索病毒搜索引擎>
https://lesuobingdu.qianxin.com/ <qax勒索病毒的搜索引擎>
https://edr.sangfor.com.cn/#/information/ransom_search <sangfor勒索病毒搜索引擎>
```

#### 解密勒索文件

```html
https://github.com/jiansiting/Decryption-Tools <解密脚本查找>
```

#### 分析溯源



***

### 恶意邮件

#### 发件人分析

```shell
nslookup -type=mx xxx.com  mx记录查询
```

